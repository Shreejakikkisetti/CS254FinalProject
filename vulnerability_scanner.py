#!/usr/bin/env python3
import socket
import paramiko
import requests
import argparse
from urllib.parse import quote
import sys
import os
from requests.auth import HTTPBasicAuth

def scan_ports(verbose=False):
    """Scan specific ports we know about."""
    known_ports = [8080, 2222]  # HTTP and SSH ports we know about
    open_ports = []
    for port in known_ports:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(1)
            result = sock.connect_ex(('127.0.0.1', port))
            if result == 0:
                open_ports.append(port)
                if verbose:
                    print(f"Found open port: {port}", file=sys.stderr)
            sock.close()
        except:
            if verbose:
                print(f"Error scanning port {port}", file=sys.stderr)
    return open_ports

def try_http_auth(port, username, password, verbose=False):
    """Attempt HTTP basic authentication on the given port."""
    try:
        if verbose:
            print(f"Trying HTTP auth on port {port} with {username}:{password}", file=sys.stderr)
        response = requests.get(
            f'http://127.0.0.1:{port}',
            auth=HTTPBasicAuth(username, password),
            timeout=5
        )
        if response.status_code == 200:
            output = response.text.strip()
            print(f"http://{quote(username)}:{quote(password)}@127.0.0.1:{port} {output}")
            return True
        elif verbose:
            print(f"HTTP auth failed: status code {response.status_code}", file=sys.stderr)
    except Exception as e:
        if verbose:
            print(f"HTTP auth error: {str(e)}", file=sys.stderr)
    return False

def try_ssh_auth(port, username, password, verbose=False):
    """Attempt SSH password authentication on the given port."""
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        if not verbose:
            # Redirect stderr to devnull to suppress paramiko warnings
            stderr_fd = sys.stderr.fileno()
            stderr_save = os.dup(stderr_fd)
            devnull = os.open(os.devnull, os.O_WRONLY)
            os.dup2(devnull, stderr_fd)
            os.close(devnull)

        if verbose:
            print(f"Trying SSH auth on port {port} with {username}:{password}", file=sys.stderr)

        client.connect(
            '127.0.0.1',
            port=port,
            username=username,
            password=password,
            timeout=5
        )
        stdin, stdout, stderr = client.exec_command('echo success')
        output = stdout.read().decode().strip()
        print(f"ssh://{quote(username)}:{quote(password)}@127.0.0.1:{port} {output}")
        client.close()

        if not verbose:
            # Restore stderr
            os.dup2(stderr_save, stderr_fd)
            os.close(stderr_save)
        return True
    except Exception as e:
        if client:
            client.close()
        if not verbose:
            try:
                # Restore stderr if we failed before
                os.dup2(stderr_save, stderr_fd)
                os.close(stderr_save)
            except:
                pass
        if verbose:
            print(f"SSH auth error: {str(e)}", file=sys.stderr)
    return False

def main():
    parser = argparse.ArgumentParser(description='Vulnerability Scanner')
    parser.add_argument('-v', '--verbose', action='store_true', help='Enable verbose output')
    args = parser.parse_args()

    credentials = {
        'admin': 'admin',
        'root': 'abc123',
        'skroob': '12345'
    }

    open_ports = scan_ports(args.verbose)
    
    for port in open_ports:
        for username, password in credentials.items():
            try_http_auth(port, username, password, args.verbose)
            try_ssh_auth(port, username, password, args.verbose)

if __name__ == '__main__':
    main()
